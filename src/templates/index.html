<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Earthquake Explorer — Hyperleaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gnat/surreal@main/surreal.js"></script>
  <script>
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function formatDate(ts) {
    var d = new Date(Number(ts));
    return MONTHS[d.getUTCMonth()] + ' ' + d.getUTCDate() + ', ' + d.getUTCFullYear();
  }
  function tsToDate(ts) {
    var d = new Date(Number(ts));
    return d.getUTCFullYear() + '-' + String(d.getUTCMonth() + 1).padStart(2, '0') + '-' + String(d.getUTCDate()).padStart(2, '0');
  }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }

    .leaflet-container, .leaflet-container * { box-sizing: content-box; }
    .leaflet-container img { max-width: none !important; }

    .layout { display: flex; height: 100vh; }
    #map { flex: 1; min-width: 0; }

    /* --- Sidebar --- */
    .sidebar {
      width: 420px;
      display: flex;
      flex-direction: column;
      background: #1e293b;
      border-left: 1px solid #334155;
    }
    .sidebar-header {
      padding: 16px 20px 12px;
      border-bottom: 1px solid #334155;
    }
    .sidebar-header h1 { font-size: 16px; font-weight: 600; color: #f1f5f9; margin-bottom: 4px; }
    .sidebar-header .subtitle { font-size: 12px; color: #94a3b8; }

    /* --- Stats bar --- */
    #stats {
      padding: 10px 20px;
      background: #0f172a;
      border-bottom: 1px solid #334155;
      display: flex; gap: 16px; flex-wrap: wrap;
      font-size: 12px; color: #94a3b8;
    }
    .stat-item b { color: #f1f5f9; }

    /* --- Filters --- */
    .filters {
      padding: 12px 20px 16px;
      border-bottom: 1px solid #334155;
      display: flex; flex-direction: column; gap: 14px;
    }
    .filter-row { display: flex; gap: 10px; align-items: center; }
    .filter-row label {
      font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; min-width: 50px;
    }
    .filter-row select {
      flex: 1; padding: 6px 8px; border: 1px solid #334155; border-radius: 4px;
      background: #0f172a; color: #e2e8f0; font-size: 13px; font-family: inherit;
    }
    .filter-row select:focus { outline: none; border-color: #3b82f6; }

    /* --- Time slider labels --- */
    .time-slider-wrap { display: flex; flex-direction: column; gap: 6px; }
    .time-slider-label {
      display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8;
    }
    .time-slider-label b { color: #e2e8f0; font-weight: 500; }

    /* --- toolcool-range-slider styling --- */
    #time-slider { margin: 4px 0; }

    /* hidden inputs for htmx */
    #filter-start, #filter-end { display: none; }

    /* --- Legend --- */
    .legend {
      padding: 10px 20px; border-bottom: 1px solid #334155;
      display: flex; gap: 16px; font-size: 11px; color: #94a3b8;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* --- Table --- */
    .table-container { flex: 1; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { position: sticky; top: 0; z-index: 1; }
    th {
      padding: 8px 12px; text-align: left; font-size: 10px; font-weight: 600;
      text-transform: uppercase; color: #64748b; background: #1e293b;
      border-bottom: 1px solid #334155;
    }
    td { padding: 6px 12px; font-size: 13px; border-bottom: 1px solid #1e293b; color: #cbd5e1; }
    .place-cell { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    tr:hover td { background: #334155; }
    .empty-state { text-align: center; padding: 32px 12px; color: #64748b; }

    /* htmx transition */
    .htmx-settling tr { opacity: 0; }
    tr { transition: opacity 0.1s ease-in; }

    /* loading overlay */
    .loading-overlay {
      position: absolute; inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.15s;
    }
    .loading-overlay.active { opacity: 1; pointer-events: auto; }
    .loading-spinner {
      width: 24px; height: 24px;
      border: 3px solid #334155; border-top-color: #3b82f6;
      border-radius: 50%; animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* active table row */
    tr.active-row td { background: #1e3a5f; }
  </style>
</head>
<body>

<div class="layout">
  <div id="map" data-center="[20, 0]" data-zoom="3">
    <div data-tile="OpenStreetMap" data-default-tile></div>
  </div>

  <!-- Hidden inputs for HTMX vals -->
  <input type="hidden" id="filter-start" value="{{ filters.start_date }}">
  <input type="hidden" id="filter-end" value="{{ filters.end_date }}">

  <!-- Hyperleaflet data source — markers go here -->
  <div data-hyperleaflet-source id="source" style="display:none"
       hx-get="/quakes"
       hx-vals="js:{
         bbox: hyperleaflet.getBBoxString(),
         start: document.getElementById('filter-start').value,
         end: document.getElementById('filter-end').value,
         min_mag: document.getElementById('filter-mag').value
       }"
       hx-trigger="hyperleaflet:ready from:window, map:move delay:300ms from:window, filterChange from:body"
       hx-swap="innerHTML settle:100ms">
    {% include "partials/markers.html" %}
  </div>

  <div class="sidebar">
    <div class="sidebar-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1>Earthquake Explorer</h1>
        <div class="subtitle">USGS data &middot; M4+ &middot; 5 years</div>
      </div>
      <a href="https://github.com/cemrehancavdar/hyperleaflet-earthquakes" target="_blank" rel="noopener"
         title="View source on GitHub" style="color:#64748b; margin-top:2px;">
        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
            0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
            -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2
            -3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82
            .64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92
            .08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07
            -.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
      </a>
    </div>

    <div id="stats">
      {% include "partials/stats.html" %}
    </div>

    <div class="filters">
      <!-- Time range slider -->
      <div class="time-slider-wrap">
        <div class="time-slider-label">
          <span><b id="label-start">{{ filters.start_label }}</b></span>
          <span><b id="label-end">{{ filters.end_label }}</b></span>
        </div>
        <tc-range-slider
          id="time-slider"
          min="{{ date_range.min_ts }}"
          max="{{ date_range.max_ts }}"
          value1="{{ filters.start_ts }}"
          value2="{{ filters.end_ts }}"
          step="{{ one_day_ms }}"
          round="0"
          range-dragging="true"
          pointers-max-distance="{{ one_year_ms }}"
          slider-bg="#334155"
          slider-bg-hover="#3b4a63"
          slider-bg-fill="#3b82f6"
          pointer-bg="#e2e8f0"
          pointer-bg-hover="#ffffff"
          pointer-bg-focus="#ffffff"
          pointer-border="2px solid #3b82f6"
          pointer-border-hover="2px solid #60a5fa"
          pointer-border-focus="2px solid #60a5fa"
          pointer-width="16px"
          pointer-height="16px"
          pointer-radius="50%"
          slider-height="6px"
          slider-radius="3px"
        ></tc-range-slider>
        <script>
          var _sliderTimer = 0
          me('#time-slider').on('change', ev => {
            var s = ev.detail.value1, e = ev.detail.value2
            me('#label-start').textContent = formatDate(s)
            me('#label-end').textContent = formatDate(e)
            me('#filter-start').value = tsToDate(s)
            me('#filter-end').value = tsToDate(e)
            clearTimeout(_sliderTimer)
            _sliderTimer = setTimeout(() => document.body.dispatchEvent(new Event('filterChange')), 400)
          })
        </script>
      </div>

      <!-- Magnitude filter -->
      <div class="filter-row">
        <label>Min M</label>
        <select id="filter-mag">
          <option value="4" {% if filters.min_mag == 4.0 %}selected{% endif %}>M4+</option>
          <option value="5">M5+</option>
          <option value="6">M6+</option>
          <option value="7">M7+</option>
        </select>
        <script>me('-').on('change', () => document.body.dispatchEvent(new Event('filterChange')))</script>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background:#eab308;border:1px solid #ca8a04;"></div>
        M4–4.9
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:#f97316;border:1px solid #ea580c;"></div>
        M5–5.9
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:#ef4444;border:1px solid #dc2626;"></div>
        M6–6.9
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:#dc2626;border:1px solid #991b1b;"></div>
        M7+
      </div>
    </div>

    <div class="table-container" style="position:relative">
      <script>
        me('body').on('htmx:beforeRequest', () => me('#loading-overlay').classAdd('active'))
        me('body').on('htmx:afterRequest', () => me('#loading-overlay').classRemove('active'))
        me().on('click', async ev => {
          var row = ev.target.closest('tr[data-quake-id]')
          if (!row) return
          any('tr.active-row').classRemove('active-row')
          me(row).classAdd('active-row')
          hyperleaflet.flyTo([Number(row.dataset.lat), Number(row.dataset.lng)], 8)
          await sleep(1000)
          hyperleaflet.openPopup(row.dataset.quakeId)
        })
      </script>
      <div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div></div>
      <div id="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Mag</th>
              <th>Location</th>
              <th>Depth</th>
              <th>When</th>
            </tr>
          </thead>
          <tbody>
            {% include "partials/rows.html" %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/hyperleaflet@0.5.0"></script>
<script src="https://cdn.jsdelivr.net/npm/toolcool-range-slider/dist/toolcool-range-slider.min.js"></script>

</body>
</html>
